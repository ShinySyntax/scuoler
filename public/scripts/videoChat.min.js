let socket,videoGrid,myVideo,myVideoStream,myName,path=window.location.pathname,ROOM_ID=path.substring(path.lastIndexOf("/")+1);const peers={};let peer,myMediaRecorder,screenShare=!1,recording=!1;const getPeer=()=>(peer||(peer=new Peer(void 0,{path:"/peerjsServer",host:"/",port:"443"})),peer),getSocket=()=>(socket||(socket=io("/")),socket),getVideoGrid=()=>(videoGrid||(videoGrid=document.getElementById("videoChat-left-video-grid"),videoGrid.insertAdjacentHTML("beforeend",'<video autoplay="true" muted="true" onclick="videoClicked(event, this)" />')),videoGrid),getMyVideo=()=>(myVideo||(myVideo=getVideoGrid().firstChild),myVideo),nameClicked=()=>{let e=document.getElementById("videChat__Dialog__input").value;myName=e,document.getElementById("videChat__Dialog").remove()},getMyName=e=>{document.getElementsByClassName("videoChat")[0].insertAdjacentHTML("beforeend",`<div id="videChat__Dialog" >\n    <span><strong>Enter your name:</strong></span>\n    <input id="videChat__Dialog__input" type="text" value="${e}"/>\n    <button onclick="nameClicked()">OK</button>\n    </div>`)},scrollToBottom=e=>{e.scrollTop=e.scrollHeight},addVideoStream=(e,t)=>{e.srcObject=t,e.onloadedmetadata=function(t){e.play()}},camMediaOptions={video:!0,audio:!0},getMyVideoStream=()=>new Promise((function(e,t){myVideoStream?e(myVideoStream):window.navigator.mediaDevices.getUserMedia(camMediaOptions).then((t=>{myVideoStream=t,addVideoStream(getMyVideo(),myVideoStream),e(myVideoStream)})).catch((e=>{console.log(`err in getting user media ${e}`),t(e)}))})),init=()=>{getMyVideoStream().then().catch((e=>{console.log(`err in getting user media ${e}`)}));const e=document.getElementById("chat_message");e.addEventListener("keyup",(function(t){if(t.preventDefault(),"Enter"===t.key&&e.value?.length>0){let t={name:myName,message:e.value};getSocket().emit("message",JSON.stringify(t)),e.value=""}})),getSocket().on("createMessage",(e=>{let t=JSON.parse(e);var o;liEl=document.createElement("li"),liEl.setAttribute("class","MessageElement"),liEl.innerHTML=`<b>${t.name.substring(0,11)}</b><br/>${t.message}`,ulEl=document.getElementById("chat-right-MessagesUl"),ulEl.appendChild(liEl),(o=ulEl).scrollTop=o.scrollHeight})),getPeer().on("open",(e=>{var t;getMyVideo()?.setAttribute("class",e),getSocket().emit("join-room",ROOM_ID,e),myName||(t=e,document.getElementsByClassName("videoChat")[0].insertAdjacentHTML("beforeend",`<div id="videChat__Dialog" >\n    <span><strong>Enter your name:</strong></span>\n    <input id="videChat__Dialog__input" type="text" value="${t}"/>\n    <button onclick="nameClicked()">OK</button>\n    </div>`))})),getSocket().on("user-connected",(e=>{console.log("user connected"),getMyVideoStream().then((t=>{connectToNewUser(e,t)})).catch((e=>{console.log(`err in getting user media ${e}`)}))})),getSocket().on("user-disconnected",(e=>{let t=document.getElementsByClassName(e)[0];t&&t.remove(),peers[e]&&peers[e].close()})),getPeer().on("call",(e=>{let t;peers[e.peer]=e,getMyVideoStream().then((t=>{e.answer(t)})).catch((e=>{console.log(`err in getting user media ${e}`)})),0===getVideoGrid().getElementsByClassName(e.peer).length&&getVideoGrid().insertAdjacentHTML("beforeend",`<video class="${e.peer}" autoplay="true"   onclick="videoClicked(event, this)" />`),e.on("stream",(o=>{t=getVideoGrid().getElementsByClassName(e.peer)[0],addVideoStream(t,o)})),e.on("close",(()=>{t.remove()}))}))};init();const connectToNewUser=(e,t)=>{const o=getPeer().call(e,t);let a;console.log("another new user",e,o),getVideoGrid().insertAdjacentHTML("beforeend",`<video class="${e}" autoplay="true"  onclick="videoClicked(event, this)" />`),o.on("stream",(t=>{a=getVideoGrid().getElementsByClassName(e)[0],addVideoStream(a,t)})),o.on("close",(()=>{a.remove()})),peers[e]=o},reconnectToExistingUser=(e,t)=>{const o=getPeer().call(e,t);let a;console.log("reconnect to existing user",e,o),o.on("stream",(t=>{a=getVideoGrid().getElementsByClassName(e)[0],addVideoStream(a,t)})),o.on("close",(()=>{a.remove()})),peers[e]=o},muteUnmute=()=>{getMyVideoStream().then((e=>{if(e.getAudioTracks().length>0){e.getAudioTracks()[0].enabled?(e.getAudioTracks()[0].enabled=!1,setUnmuteButton()):(e.getAudioTracks()[0].enabled=!0,setMuteButton())}}))},setMuteButton=()=>{document.getElementsByClassName("videoChat__left__mute__button")[0].innerHTML='<i class="fas fa-microphone"></i>\n                <span>Mute</span>'},setUnmuteButton=()=>{document.getElementsByClassName("videoChat__left__mute__button")[0].innerHTML='<i class="unmute fas fa-microphone-slash"></i>\n                <span>Unmute</span>'},stopUnstopVideo=()=>{getMyVideoStream().then((e=>{e.getVideoTracks()[0].enabled?(e.getVideoTracks()[0].enabled=!1,setPlayVideoButton()):(e.getVideoTracks()[0].enabled=!0,setStopVideoButton())}))},setStopVideoButton=()=>{document.getElementsByClassName("videoChat__left__stopVideo__button")[0].innerHTML='<i class="fa-solid fa-video"></i>\n                <span>Stop Video</span>'},setPlayVideoButton=()=>{document.getElementsByClassName("videoChat__left__stopVideo__button")[0].innerHTML='<i class="stop fa-solid fa-video-slash"></i>\n                <span>Play Video</span>'},switchToScreenShare=async()=>{let e=await getMyVideoStream();if(screenShare){let t=await window.navigator.mediaDevices.getUserMedia(camMediaOptions);await replaceVideoTracks(e,t),screenShare=!1,setNoScreenShareButton()}else{let t=await window.navigator.mediaDevices.getDisplayMedia(camMediaOptions);await replaceVideoTracks(e,t),screenShare=!0,setScreenShareButton()}Object.keys(peers).map((t=>{reconnectToExistingUser(t,e)}))},setScreenShareButton=()=>{document.getElementsByClassName("videoChat__left__screenshare__button")[0].innerHTML='<i class="screenShare fas fa-desktop"></i>\n                <span>Screenshare</span>'},setNoScreenShareButton=()=>{document.getElementsByClassName("videoChat__left__screenshare__button")[0].innerHTML='<i class="noScreenShare fas fa-desktop"></i>\n                <span>Screenshare</span>'},replaceVideoTracks=async(e,t)=>{let o=[...e.getTracks()];for(let t=0;t<o.length;t++)"video"===o[t].kind&&await e.removeTrack(o[t]);for(let o=0;o<t.getTracks().length;o++)"video"===t.getTracks()[o].kind&&await e.addTrack(t.getTracks()[o])},saveFile=e=>{const t=new Blob(e,{type:"video/webm"});let o=window.prompt("Enter file name"),a=document.createElement("a");a.href=URL.createObjectURL(t),a.download=`${o}.webm`,document.body.appendChild(a),a.click(),URL.revokeObjectURL(t),document.body.removeChild(a)},createRecorder=(e,t)=>{let o=[];const a=new MediaRecorder(e);return a.ondataavailable=function(e){e.data.size>0&&o.push(e.data)},a.onstop=function(){saveFile(o),o=[]},a.start(200),a},addAudioTracks=async e=>{let t=[...(await getMyVideoStream()).getAudioTracks()];for(let o=0;o<t.length;o++)await e.addTrack(t[o])},startRecord=async()=>{if(recording)myMediaRecorder.stop(),recording=!1,setNoRecordButton();else{let e;screenShare?e=await getMyVideoStream():(e=await window.navigator.mediaDevices.getDisplayMedia(camMediaOptions),await addAudioTracks(e));myMediaRecorder=createRecorder(e),recording=!0,setRecordButton()}},setRecordButton=()=>{document.getElementsByClassName("videoChat__left__record__button")[0].innerHTML='<i class="record fas fa-record-vinyl"></i>\n                <span>Record</span>'},setNoRecordButton=()=>{document.getElementsByClassName("videoChat__left__record__button")[0].innerHTML='<i class="noRecord fas fa-record-vinyl"></i>\n                <span>Record</span>'},leaveMeeting=()=>{window.confirm("Do you really want to leave the Meeting?")&&window.location.replace("/")},videoClicked=(e,t)=>{let o;if(o=document.getElementById("maxVideo"),!o){document.getElementsByClassName("videoChat")[0].insertAdjacentHTML("beforeend",' <video id="maxVideo" autoplay="true" muted="true" onclick="maxVideoClicked(this)"></video>'),o=document.getElementById("maxVideo")}o.srcObject=t.srcObject},maxVideoClicked=e=>{e.remove()};