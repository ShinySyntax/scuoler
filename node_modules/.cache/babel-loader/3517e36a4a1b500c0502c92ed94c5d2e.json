{"ast":null,"code":"/* global attachEvent */\n\n/**\n * Module requirements.\n */\nvar XMLHttpRequest = require('xmlhttprequest-ssl');\n\nvar Polling = require('./polling');\n\nvar Emitter = require('component-emitter');\n\nvar inherit = require('component-inherit');\n\nvar debug = require('debug')('engine.io-client:polling-xhr');\n\nvar globalThis = require('../globalThis');\n/**\n * Module exports.\n */\n\n\nmodule.exports = XHR;\nmodule.exports.Request = Request;\n/**\n * Empty function\n */\n\nfunction empty() {}\n/**\n * XHR Polling constructor.\n *\n * @param {Object} opts\n * @api public\n */\n\n\nfunction XHR(opts) {\n  Polling.call(this, opts);\n  this.requestTimeout = opts.requestTimeout;\n  this.extraHeaders = opts.extraHeaders;\n\n  if (typeof location !== 'undefined') {\n    var isSSL = 'https:' === location.protocol;\n    var port = location.port; // some user agents have empty `location.port`\n\n    if (!port) {\n      port = isSSL ? 443 : 80;\n    }\n\n    this.xd = typeof location !== 'undefined' && opts.hostname !== location.hostname || port !== opts.port;\n    this.xs = opts.secure !== isSSL;\n  }\n}\n/**\n * Inherits from Polling.\n */\n\n\ninherit(XHR, Polling);\n/**\n * XHR supports binary\n */\n\nXHR.prototype.supportsBinary = true;\n/**\n * Creates a request.\n *\n * @param {String} method\n * @api private\n */\n\nXHR.prototype.request = function (opts) {\n  opts = opts || {};\n  opts.uri = this.uri();\n  opts.xd = this.xd;\n  opts.xs = this.xs;\n  opts.agent = this.agent || false;\n  opts.supportsBinary = this.supportsBinary;\n  opts.enablesXDR = this.enablesXDR;\n  opts.withCredentials = this.withCredentials; // SSL options for Node.js client\n\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n  opts.requestTimeout = this.requestTimeout; // other options for Node.js client\n\n  opts.extraHeaders = this.extraHeaders;\n  return new Request(opts);\n};\n/**\n * Sends data.\n *\n * @param {String} data to send.\n * @param {Function} called upon flush.\n * @api private\n */\n\n\nXHR.prototype.doWrite = function (data, fn) {\n  var isBinary = typeof data !== 'string' && data !== undefined;\n  var req = this.request({\n    method: 'POST',\n    data: data,\n    isBinary: isBinary\n  });\n  var self = this;\n  req.on('success', fn);\n  req.on('error', function (err) {\n    self.onError('xhr post error', err);\n  });\n  this.sendXhr = req;\n};\n/**\n * Starts a poll cycle.\n *\n * @api private\n */\n\n\nXHR.prototype.doPoll = function () {\n  debug('xhr poll');\n  var req = this.request();\n  var self = this;\n  req.on('data', function (data) {\n    self.onData(data);\n  });\n  req.on('error', function (err) {\n    self.onError('xhr poll error', err);\n  });\n  this.pollXhr = req;\n};\n/**\n * Request constructor\n *\n * @param {Object} options\n * @api public\n */\n\n\nfunction Request(opts) {\n  this.method = opts.method || 'GET';\n  this.uri = opts.uri;\n  this.xd = !!opts.xd;\n  this.xs = !!opts.xs;\n  this.async = false !== opts.async;\n  this.data = undefined !== opts.data ? opts.data : null;\n  this.agent = opts.agent;\n  this.isBinary = opts.isBinary;\n  this.supportsBinary = opts.supportsBinary;\n  this.enablesXDR = opts.enablesXDR;\n  this.withCredentials = opts.withCredentials;\n  this.requestTimeout = opts.requestTimeout; // SSL options for Node.js client\n\n  this.pfx = opts.pfx;\n  this.key = opts.key;\n  this.passphrase = opts.passphrase;\n  this.cert = opts.cert;\n  this.ca = opts.ca;\n  this.ciphers = opts.ciphers;\n  this.rejectUnauthorized = opts.rejectUnauthorized; // other options for Node.js client\n\n  this.extraHeaders = opts.extraHeaders;\n  this.create();\n}\n/**\n * Mix in `Emitter`.\n */\n\n\nEmitter(Request.prototype);\n/**\n * Creates the XHR object and sends the request.\n *\n * @api private\n */\n\nRequest.prototype.create = function () {\n  var opts = {\n    agent: this.agent,\n    xdomain: this.xd,\n    xscheme: this.xs,\n    enablesXDR: this.enablesXDR\n  }; // SSL options for Node.js client\n\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n  var xhr = this.xhr = new XMLHttpRequest(opts);\n  var self = this;\n\n  try {\n    debug('xhr open %s: %s', this.method, this.uri);\n    xhr.open(this.method, this.uri, this.async);\n\n    try {\n      if (this.extraHeaders) {\n        xhr.setDisableHeaderCheck && xhr.setDisableHeaderCheck(true);\n\n        for (var i in this.extraHeaders) {\n          if (this.extraHeaders.hasOwnProperty(i)) {\n            xhr.setRequestHeader(i, this.extraHeaders[i]);\n          }\n        }\n      }\n    } catch (e) {}\n\n    if ('POST' === this.method) {\n      try {\n        if (this.isBinary) {\n          xhr.setRequestHeader('Content-type', 'application/octet-stream');\n        } else {\n          xhr.setRequestHeader('Content-type', 'text/plain;charset=UTF-8');\n        }\n      } catch (e) {}\n    }\n\n    try {\n      xhr.setRequestHeader('Accept', '*/*');\n    } catch (e) {} // ie6 check\n\n\n    if ('withCredentials' in xhr) {\n      xhr.withCredentials = this.withCredentials;\n    }\n\n    if (this.requestTimeout) {\n      xhr.timeout = this.requestTimeout;\n    }\n\n    if (this.hasXDR()) {\n      xhr.onload = function () {\n        self.onLoad();\n      };\n\n      xhr.onerror = function () {\n        self.onError(xhr.responseText);\n      };\n    } else {\n      xhr.onreadystatechange = function () {\n        if (xhr.readyState === 2) {\n          try {\n            var contentType = xhr.getResponseHeader('Content-Type');\n\n            if (self.supportsBinary && contentType === 'application/octet-stream' || contentType === 'application/octet-stream; charset=UTF-8') {\n              xhr.responseType = 'arraybuffer';\n            }\n          } catch (e) {}\n        }\n\n        if (4 !== xhr.readyState) return;\n\n        if (200 === xhr.status || 1223 === xhr.status) {\n          self.onLoad();\n        } else {\n          // make sure the `error` event handler that's user-set\n          // does not throw in the same tick and gets caught here\n          setTimeout(function () {\n            self.onError(typeof xhr.status === 'number' ? xhr.status : 0);\n          }, 0);\n        }\n      };\n    }\n\n    debug('xhr data %s', this.data);\n    xhr.send(this.data);\n  } catch (e) {\n    // Need to defer since .create() is called directly fhrom the constructor\n    // and thus the 'error' event can only be only bound *after* this exception\n    // occurs.  Therefore, also, we cannot throw here at all.\n    setTimeout(function () {\n      self.onError(e);\n    }, 0);\n    return;\n  }\n\n  if (typeof document !== 'undefined') {\n    this.index = Request.requestsCount++;\n    Request.requests[this.index] = this;\n  }\n};\n/**\n * Called upon successful response.\n *\n * @api private\n */\n\n\nRequest.prototype.onSuccess = function () {\n  this.emit('success');\n  this.cleanup();\n};\n/**\n * Called if we have data.\n *\n * @api private\n */\n\n\nRequest.prototype.onData = function (data) {\n  this.emit('data', data);\n  this.onSuccess();\n};\n/**\n * Called upon error.\n *\n * @api private\n */\n\n\nRequest.prototype.onError = function (err) {\n  this.emit('error', err);\n  this.cleanup(true);\n};\n/**\n * Cleans up house.\n *\n * @api private\n */\n\n\nRequest.prototype.cleanup = function (fromError) {\n  if ('undefined' === typeof this.xhr || null === this.xhr) {\n    return;\n  } // xmlhttprequest\n\n\n  if (this.hasXDR()) {\n    this.xhr.onload = this.xhr.onerror = empty;\n  } else {\n    this.xhr.onreadystatechange = empty;\n  }\n\n  if (fromError) {\n    try {\n      this.xhr.abort();\n    } catch (e) {}\n  }\n\n  if (typeof document !== 'undefined') {\n    delete Request.requests[this.index];\n  }\n\n  this.xhr = null;\n};\n/**\n * Called upon load.\n *\n * @api private\n */\n\n\nRequest.prototype.onLoad = function () {\n  var data;\n\n  try {\n    var contentType;\n\n    try {\n      contentType = this.xhr.getResponseHeader('Content-Type');\n    } catch (e) {}\n\n    if (contentType === 'application/octet-stream' || contentType === 'application/octet-stream; charset=UTF-8') {\n      data = this.xhr.response || this.xhr.responseText;\n    } else {\n      data = this.xhr.responseText;\n    }\n  } catch (e) {\n    this.onError(e);\n  }\n\n  if (null != data) {\n    this.onData(data);\n  }\n};\n/**\n * Check if it has XDomainRequest.\n *\n * @api private\n */\n\n\nRequest.prototype.hasXDR = function () {\n  return typeof XDomainRequest !== 'undefined' && !this.xs && this.enablesXDR;\n};\n/**\n * Aborts the request.\n *\n * @api public\n */\n\n\nRequest.prototype.abort = function () {\n  this.cleanup();\n};\n/**\n * Aborts pending requests when unloading the window. This is needed to prevent\n * memory leaks (e.g. when using IE) and to ensure that no spurious error is\n * emitted.\n */\n\n\nRequest.requestsCount = 0;\nRequest.requests = {};\n\nif (typeof document !== 'undefined') {\n  if (typeof attachEvent === 'function') {\n    attachEvent('onunload', unloadHandler);\n  } else if (typeof addEventListener === 'function') {\n    var terminationEvent = 'onpagehide' in globalThis ? 'pagehide' : 'unload';\n    addEventListener(terminationEvent, unloadHandler, false);\n  }\n}\n\nfunction unloadHandler() {\n  for (var i in Request.requests) {\n    if (Request.requests.hasOwnProperty(i)) {\n      Request.requests[i].abort();\n    }\n  }\n}","map":{"version":3,"sources":["/home/mathew/javascript/ischools/node_modules/engine.io-client/lib/transports/polling-xhr.js"],"names":["XMLHttpRequest","require","Polling","Emitter","inherit","debug","globalThis","module","exports","XHR","Request","empty","opts","call","requestTimeout","extraHeaders","location","isSSL","protocol","port","xd","hostname","xs","secure","prototype","supportsBinary","request","uri","agent","enablesXDR","withCredentials","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","doWrite","data","fn","isBinary","undefined","req","method","self","on","err","onError","sendXhr","doPoll","onData","pollXhr","async","create","xdomain","xscheme","xhr","open","setDisableHeaderCheck","i","hasOwnProperty","setRequestHeader","e","timeout","hasXDR","onload","onLoad","onerror","responseText","onreadystatechange","readyState","contentType","getResponseHeader","responseType","status","setTimeout","send","document","index","requestsCount","requests","onSuccess","emit","cleanup","fromError","abort","response","XDomainRequest","attachEvent","unloadHandler","addEventListener","terminationEvent"],"mappings":"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","sourcesContent":["/* global attachEvent */\n\n/**\n * Module requirements.\n */\n\nvar XMLHttpRequest = require('xmlhttprequest-ssl');\nvar Polling = require('./polling');\nvar Emitter = require('component-emitter');\nvar inherit = require('component-inherit');\nvar debug = require('debug')('engine.io-client:polling-xhr');\nvar globalThis = require('../globalThis');\n\n/**\n * Module exports.\n */\n\nmodule.exports = XHR;\nmodule.exports.Request = Request;\n\n/**\n * Empty function\n */\n\nfunction empty () {}\n\n/**\n * XHR Polling constructor.\n *\n * @param {Object} opts\n * @api public\n */\n\nfunction XHR (opts) {\n  Polling.call(this, opts);\n  this.requestTimeout = opts.requestTimeout;\n  this.extraHeaders = opts.extraHeaders;\n\n  if (typeof location !== 'undefined') {\n    var isSSL = 'https:' === location.protocol;\n    var port = location.port;\n\n    // some user agents have empty `location.port`\n    if (!port) {\n      port = isSSL ? 443 : 80;\n    }\n\n    this.xd = (typeof location !== 'undefined' && opts.hostname !== location.hostname) ||\n      port !== opts.port;\n    this.xs = opts.secure !== isSSL;\n  }\n}\n\n/**\n * Inherits from Polling.\n */\n\ninherit(XHR, Polling);\n\n/**\n * XHR supports binary\n */\n\nXHR.prototype.supportsBinary = true;\n\n/**\n * Creates a request.\n *\n * @param {String} method\n * @api private\n */\n\nXHR.prototype.request = function (opts) {\n  opts = opts || {};\n  opts.uri = this.uri();\n  opts.xd = this.xd;\n  opts.xs = this.xs;\n  opts.agent = this.agent || false;\n  opts.supportsBinary = this.supportsBinary;\n  opts.enablesXDR = this.enablesXDR;\n  opts.withCredentials = this.withCredentials;\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n  opts.requestTimeout = this.requestTimeout;\n\n  // other options for Node.js client\n  opts.extraHeaders = this.extraHeaders;\n\n  return new Request(opts);\n};\n\n/**\n * Sends data.\n *\n * @param {String} data to send.\n * @param {Function} called upon flush.\n * @api private\n */\n\nXHR.prototype.doWrite = function (data, fn) {\n  var isBinary = typeof data !== 'string' && data !== undefined;\n  var req = this.request({ method: 'POST', data: data, isBinary: isBinary });\n  var self = this;\n  req.on('success', fn);\n  req.on('error', function (err) {\n    self.onError('xhr post error', err);\n  });\n  this.sendXhr = req;\n};\n\n/**\n * Starts a poll cycle.\n *\n * @api private\n */\n\nXHR.prototype.doPoll = function () {\n  debug('xhr poll');\n  var req = this.request();\n  var self = this;\n  req.on('data', function (data) {\n    self.onData(data);\n  });\n  req.on('error', function (err) {\n    self.onError('xhr poll error', err);\n  });\n  this.pollXhr = req;\n};\n\n/**\n * Request constructor\n *\n * @param {Object} options\n * @api public\n */\n\nfunction Request (opts) {\n  this.method = opts.method || 'GET';\n  this.uri = opts.uri;\n  this.xd = !!opts.xd;\n  this.xs = !!opts.xs;\n  this.async = false !== opts.async;\n  this.data = undefined !== opts.data ? opts.data : null;\n  this.agent = opts.agent;\n  this.isBinary = opts.isBinary;\n  this.supportsBinary = opts.supportsBinary;\n  this.enablesXDR = opts.enablesXDR;\n  this.withCredentials = opts.withCredentials;\n  this.requestTimeout = opts.requestTimeout;\n\n  // SSL options for Node.js client\n  this.pfx = opts.pfx;\n  this.key = opts.key;\n  this.passphrase = opts.passphrase;\n  this.cert = opts.cert;\n  this.ca = opts.ca;\n  this.ciphers = opts.ciphers;\n  this.rejectUnauthorized = opts.rejectUnauthorized;\n\n  // other options for Node.js client\n  this.extraHeaders = opts.extraHeaders;\n\n  this.create();\n}\n\n/**\n * Mix in `Emitter`.\n */\n\nEmitter(Request.prototype);\n\n/**\n * Creates the XHR object and sends the request.\n *\n * @api private\n */\n\nRequest.prototype.create = function () {\n  var opts = { agent: this.agent, xdomain: this.xd, xscheme: this.xs, enablesXDR: this.enablesXDR };\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n\n  var xhr = this.xhr = new XMLHttpRequest(opts);\n  var self = this;\n\n  try {\n    debug('xhr open %s: %s', this.method, this.uri);\n    xhr.open(this.method, this.uri, this.async);\n    try {\n      if (this.extraHeaders) {\n        xhr.setDisableHeaderCheck && xhr.setDisableHeaderCheck(true);\n        for (var i in this.extraHeaders) {\n          if (this.extraHeaders.hasOwnProperty(i)) {\n            xhr.setRequestHeader(i, this.extraHeaders[i]);\n          }\n        }\n      }\n    } catch (e) {}\n\n    if ('POST' === this.method) {\n      try {\n        if (this.isBinary) {\n          xhr.setRequestHeader('Content-type', 'application/octet-stream');\n        } else {\n          xhr.setRequestHeader('Content-type', 'text/plain;charset=UTF-8');\n        }\n      } catch (e) {}\n    }\n\n    try {\n      xhr.setRequestHeader('Accept', '*/*');\n    } catch (e) {}\n\n    // ie6 check\n    if ('withCredentials' in xhr) {\n      xhr.withCredentials = this.withCredentials;\n    }\n\n    if (this.requestTimeout) {\n      xhr.timeout = this.requestTimeout;\n    }\n\n    if (this.hasXDR()) {\n      xhr.onload = function () {\n        self.onLoad();\n      };\n      xhr.onerror = function () {\n        self.onError(xhr.responseText);\n      };\n    } else {\n      xhr.onreadystatechange = function () {\n        if (xhr.readyState === 2) {\n          try {\n            var contentType = xhr.getResponseHeader('Content-Type');\n            if (self.supportsBinary && contentType === 'application/octet-stream' || contentType === 'application/octet-stream; charset=UTF-8') {\n              xhr.responseType = 'arraybuffer';\n            }\n          } catch (e) {}\n        }\n        if (4 !== xhr.readyState) return;\n        if (200 === xhr.status || 1223 === xhr.status) {\n          self.onLoad();\n        } else {\n          // make sure the `error` event handler that's user-set\n          // does not throw in the same tick and gets caught here\n          setTimeout(function () {\n            self.onError(typeof xhr.status === 'number' ? xhr.status : 0);\n          }, 0);\n        }\n      };\n    }\n\n    debug('xhr data %s', this.data);\n    xhr.send(this.data);\n  } catch (e) {\n    // Need to defer since .create() is called directly fhrom the constructor\n    // and thus the 'error' event can only be only bound *after* this exception\n    // occurs.  Therefore, also, we cannot throw here at all.\n    setTimeout(function () {\n      self.onError(e);\n    }, 0);\n    return;\n  }\n\n  if (typeof document !== 'undefined') {\n    this.index = Request.requestsCount++;\n    Request.requests[this.index] = this;\n  }\n};\n\n/**\n * Called upon successful response.\n *\n * @api private\n */\n\nRequest.prototype.onSuccess = function () {\n  this.emit('success');\n  this.cleanup();\n};\n\n/**\n * Called if we have data.\n *\n * @api private\n */\n\nRequest.prototype.onData = function (data) {\n  this.emit('data', data);\n  this.onSuccess();\n};\n\n/**\n * Called upon error.\n *\n * @api private\n */\n\nRequest.prototype.onError = function (err) {\n  this.emit('error', err);\n  this.cleanup(true);\n};\n\n/**\n * Cleans up house.\n *\n * @api private\n */\n\nRequest.prototype.cleanup = function (fromError) {\n  if ('undefined' === typeof this.xhr || null === this.xhr) {\n    return;\n  }\n  // xmlhttprequest\n  if (this.hasXDR()) {\n    this.xhr.onload = this.xhr.onerror = empty;\n  } else {\n    this.xhr.onreadystatechange = empty;\n  }\n\n  if (fromError) {\n    try {\n      this.xhr.abort();\n    } catch (e) {}\n  }\n\n  if (typeof document !== 'undefined') {\n    delete Request.requests[this.index];\n  }\n\n  this.xhr = null;\n};\n\n/**\n * Called upon load.\n *\n * @api private\n */\n\nRequest.prototype.onLoad = function () {\n  var data;\n  try {\n    var contentType;\n    try {\n      contentType = this.xhr.getResponseHeader('Content-Type');\n    } catch (e) {}\n    if (contentType === 'application/octet-stream' || contentType === 'application/octet-stream; charset=UTF-8') {\n      data = this.xhr.response || this.xhr.responseText;\n    } else {\n      data = this.xhr.responseText;\n    }\n  } catch (e) {\n    this.onError(e);\n  }\n  if (null != data) {\n    this.onData(data);\n  }\n};\n\n/**\n * Check if it has XDomainRequest.\n *\n * @api private\n */\n\nRequest.prototype.hasXDR = function () {\n  return typeof XDomainRequest !== 'undefined' && !this.xs && this.enablesXDR;\n};\n\n/**\n * Aborts the request.\n *\n * @api public\n */\n\nRequest.prototype.abort = function () {\n  this.cleanup();\n};\n\n/**\n * Aborts pending requests when unloading the window. This is needed to prevent\n * memory leaks (e.g. when using IE) and to ensure that no spurious error is\n * emitted.\n */\n\nRequest.requestsCount = 0;\nRequest.requests = {};\n\nif (typeof document !== 'undefined') {\n  if (typeof attachEvent === 'function') {\n    attachEvent('onunload', unloadHandler);\n  } else if (typeof addEventListener === 'function') {\n    var terminationEvent = 'onpagehide' in globalThis ? 'pagehide' : 'unload';\n    addEventListener(terminationEvent, unloadHandler, false);\n  }\n}\n\nfunction unloadHandler () {\n  for (var i in Request.requests) {\n    if (Request.requests.hasOwnProperty(i)) {\n      Request.requests[i].abort();\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"script"}