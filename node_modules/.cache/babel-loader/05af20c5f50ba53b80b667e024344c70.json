{"ast":null,"code":"var _jsxFileName = \"/home/mathew/javascript/ischools-react/client/src/components/MeetingShowSelected.js\";\nimport React from 'react';\nimport { Redirect } from 'react-router-dom';\nimport socketIOClient from \"socket.io-client\";\nimport data from \"./data\";\nimport '../css/Chat.css';\nimport VideoExt from './chat/VideoExt';\nimport SocketX from './chat/SocketX';\nimport PeerConnectionExt from './chat/PeerConnectionExt';\nconst ICE_SERVERS = [{\n  urls: 'turn:numb.viagenie.ca',\n  credential: 'muazkh',\n  username: 'webrtc@live.com'\n}, {\n  url: 'turn:192.158.29.39:3478?transport=tcp',\n  credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',\n  username: '28224511:1379330808'\n}, {\n  url: 'turn:turn.anyfirewall.com:443?transport=tcp',\n  credential: 'webrtc',\n  username: 'webrtc'\n}, {\n  url: 'turn:13.250.13.83:3478?transport=tcp',\n  credential: 'YzYNCouZM1mhqhmseWk6',\n  username: 'YzYNCouZM1mhqhmseWk6'\n}, {\n  urls: 'stun:stun.l.google.com:19302'\n},\n/*{ urls: 'stun:stun1.l.google.com:19302' },\n{ urls: 'stun:stun2.l.google.com:19302' },\n{ urls: 'stun:stun3.l.google.com:19302' },\n{ urls: 'stun:stun4.l.google.com:19302' },*/\n{\n  urls: 'stun:stun.ekiga.net'\n}];\n\nclass MeetingShowSelected extends React.Component {\n  constructor(props) {\n    super(props);\n\n    this.dualShareHandler = mediaStream => {\n      this.setState({\n        localStream: mediaStream\n      });\n    };\n\n    this.errorHandler = error => {\n      console.log(error.message);\n    };\n\n    this.shareScreenChange = async e => {\n      let isChecked = e.target.checked;\n      let {\n        localStream\n      } = this.state;\n      let dualStream;\n\n      if (isChecked) {\n        dualStream = await navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions);\n      } else {\n        dualStream = await navigator.mediaDevices.getUserMedia(this.camMediaOptions);\n      }\n\n      if (localStream === null) {\n        //dualStream.getTracks().forEach(track => this.peerConnection.addTrack(track));\n        this.setState({\n          localStream: dualStream,\n          shareScreen: isChecked\n        });\n      } else {\n        let trackArr = [...localStream.getTracks()];\n\n        for (let i = 0; i < trackArr.length; i++) await localStream.removeTrack(trackArr[i]); //const senders = this.peerConnection.getSenders();\n\n\n        for (let i = 0; i < dualStream.getTracks().length; i++) {\n          await localStream.addTrack(dualStream.getTracks()[i]);\n          /*senders.forEach((sender) => {\n                              if(dualStream.getTracks()[i].kind===sender.track.kind)\n                                  sender.replaceTrack(dualStream.getTracks()[i]);\n                            });*/\n        }\n\n        this.setState({\n          shareScreen: isChecked\n        });\n      }\n    };\n\n    this.onSocketConnect = () => {\n      if (this.socket) {\n        this.socket.emit(\"map\", {\n          userName: this.props.loggedInUserFullName,\n          userId: this.props.loggedInUser\n        });\n        console.log(this.socket);\n        console.log(' mapped to ' + this.props.loggedInUser);\n      }\n    };\n\n    this.onUpdateUserList = data => {\n      let userIds = [...this.state.userIds];\n      let newUserIds = data.userIds;\n      newUserIds.forEach(id => {\n        if (!userIds.includes(id)) userIds.push(id);\n      });\n      console.log('In update user list');\n      console.log(userIds);\n      console.log(data.nameMap);\n      this.setState({\n        userIds,\n        userNameMap: data.nameMap\n      }, () => {\n        if (userIds.includes(this.organiserId) && !this.state.callMadeByNonOrganiser) this.callUser(this.organiserId);\n      });\n    };\n\n    this.callUser = async userId => {\n      console.log('Call User ' + userId + ' ' + this.state.userNameMap[userId]);\n      this.peerConnections[userId] = new RTCPeerConnection({\n        iceServers: ICE_SERVERS\n      });\n      if (!this.isRemotePlaying[userId]) this.isRemotePlaying[userId] = false;\n      if (!this.callAttempts[userId]) this.callAttempts[userId] = 0;else this.callAttempts[userId]++;\n      const offer = await this.peerConnections[userId].createOffer();\n      await this.peerConnections[userId].setLocalDescription(new RTCSessionDescription(offer));\n      console.log(JSON.stringify(offer)); //console.log(this.peerConnection);\n\n      if (!this.isRemotePlaying[userId] && this.callAttempts[userId] < 3) {\n        this.socket.emit(\"call-user\", {\n          offer,\n          to: userId,\n          from: this.props.loggedInUser\n        });\n        if (this.organiserId !== this.state.loggedInUser) this.setState({\n          callMadeByNonOrganiser: true,\n          message: `Talking with: user: ${this.state.userNameMap[userId]} (${userId})`\n        });else this.setState({\n          message: `Talking with: user: ${this.state.userNameMap[userId]} (${userId})`\n        });\n      }\n    };\n\n    this.onCallRcvd = async data => {\n      console.log('callRcvd ' + this.state.callRcvd);\n      this.peerConnections[data.from] = new RTCPeerConnection({\n        iceServers: ICE_SERVERS\n      });\n      await this.peerConnections[data.from].setRemoteDescription(new RTCSessionDescription(data.offer));\n      const answer = await this.peerConnections[data.from].createAnswer();\n      console.log('call received');\n      console.log('answer \\n' + JSON.stringify(answer));\n      await this.peerConnections[data.from].setLocalDescription(new RTCSessionDescription(answer)); //console.log(this.peerConnections[data.from]);\n\n      this.socket.emit(\"make-answer\", {\n        answer,\n        to: data.from,\n        from: this.props.loggedInUser\n      });\n      this.setState({\n        callRcvd: true\n      });\n    };\n\n    this.onAnswerRcvd = async data => {\n      console.log('on Answer Rcvd' + JSON.stringify(data.answer));\n      await this.peerConnections[data.from].setRemoteDescription(new RTCSessionDescription(data.answer));\n\n      if (!this.state.answerRcvd && !this.state.callRcvd) {\n        this.setState({\n          answerRcvd: true\n        });\n      }\n\n      this.socket.emit(\"ack-callee\", {\n        to: data.from,\n        from: this.props.loggedInUser\n      });\n    };\n\n    this.onAckCalleeRcvd = data => {\n      console.log('on ack callee received, callAttempts ' + this.callAttempts[data.from] + ' remotePlaying' + this.isRemotePlaying[data.from]); //if(this.state.remoteStream.getTracks().length<=0 && this.callAttempts<3){\n\n      this.callUser(data.from, null).then();\n    };\n\n    this.onRemoveUser = ({\n      userId\n    }) => {\n      console.log('removing user ' + userId);\n      let userIds = this.state.userIds.filter(val => val !== userId);\n      let userNameMap = {};\n\n      for (let attr in this.state.userNameMap) {\n        if (userIds.includes(attr)) userNameMap[attr] = this.state.userNameMap[attr];\n      }\n\n      if (this.props.loggedInUser === this.organiserId) {\n        delete this.peerConnections[userId];\n      }\n\n      if (userId === this.organiserId) this.setState({\n        userNameMap,\n        userIds,\n        callMadeByNonOrganiser: false\n      });else this.setState({\n        userNameMap,\n        userIds\n      });\n    };\n\n    this.handleIceCandidate = async data => {};\n\n    this.state = {\n      icons: data.icons,\n      userIds: [],\n      userNameMap: {},\n      message: 'Select a user on the left menu to start sharing.',\n      callMadeByNonOrganiser: false,\n      callRcvd: false,\n      answerRcvd: false,\n      localStream: null,\n      remoteStreams: null,\n      shareScreen: false\n    };\n    const {\n      params\n    } = this.props.match;\n    this.meetingId = params.id;\n    this.organiserId = params.organiserId;\n    this.peerConnections = {};\n    this.callAttempts = {};\n    this.isRemotePlaying = {}; //this.socket = socketIOClient(ENDPOINT);\n\n    this.socket = socketIOClient(\"/\" + this.meetingId);\n    this.displayMediaOptions = {\n      video: {\n        cursor: \"always\"\n      },\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n    this.camMediaOptions = {\n      video: true,\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n  }\n\n  componentDidMount() {\n    if (this.props.loggedInUserFullName !== '') {\n      if (this.state.shareScreen) {\n        navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);\n      } else {\n        navigator.mediaDevices.getUserMedia(this.camMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);\n        ;\n      }\n    }\n  }\n\n  render() {\n    if (this.props.loggedInUserFullName === '') {\n      return /*#__PURE__*/React.createElement(Redirect, {\n        to: \"/errorLogin\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 258,\n          columnNumber: 16\n        }\n      });\n    } else {\n      return /*#__PURE__*/React.createElement(\"div\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 263,\n          columnNumber: 13\n        }\n      }, \"Meeting Show Selected\", /*#__PURE__*/React.createElement(SocketX, {\n        socket: this.socket,\n        onSocketConnect: this.onSocketConnect,\n        onUpdateUserList: this.onUpdateUserList,\n        onRemoveUser: this.onRemoveUser,\n        onCallRcvd: this.onCallRcvd,\n        onAnswerRcvd: this.onAnswerRcvd,\n        onAckCalleeRcvd: this.onAckCalleeRcvd,\n        handleIceCandidate: this.handleIceCandidate,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 265,\n          columnNumber: 14\n        }\n      }), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"content-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 275,\n          columnNumber: 15\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"active-users-panel\",\n        id: \"active-user-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 276,\n          columnNumber: 21\n        }\n      }, /*#__PURE__*/React.createElement(\"h3\", {\n        className: \"panel-title\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 277,\n          columnNumber: 23\n        }\n      }, \"Callable Users:\"), this.state.userIds.map(val => /*#__PURE__*/React.createElement(\"div\", {\n        id: val,\n        key: val,\n        className: \"active-user\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 278,\n          columnNumber: 53\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        className: \"username\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 279,\n          columnNumber: 57\n        }\n      }, this.state.userNameMap[val], \"(\", val, \")\")))), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"video-chat-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 286,\n          columnNumber: 21\n        }\n      }, /*#__PURE__*/React.createElement(\"h2\", {\n        className: \"talk-info\",\n        id: \"talking-with-info\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 288,\n          columnNumber: 27\n        }\n      }, this.state.message), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"video-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 291,\n          columnNumber: 27\n        }\n      }, \"Share Screen: \", /*#__PURE__*/React.createElement(\"input\", {\n        type: \"checkbox\",\n        id: \"shareScreen\",\n        checked: this.state.shareScreen,\n        onChange: this.shareScreenChange,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 292,\n          columnNumber: 43\n        }\n      }), /*#__PURE__*/React.createElement(\"br\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 294,\n          columnNumber: 29\n        }\n      }), /*#__PURE__*/React.createElement(VideoExt, {\n        controls: true,\n        muted: \"muted\",\n        mediaStream: this.state.localStream,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 295,\n          columnNumber: 29\n        }\n      })))));\n    }\n  }\n\n}\n\nexport default MeetingShowSelected;","map":{"version":3,"sources":["/home/mathew/javascript/ischools-react/client/src/components/MeetingShowSelected.js"],"names":["React","Redirect","socketIOClient","data","VideoExt","SocketX","PeerConnectionExt","ICE_SERVERS","urls","credential","username","url","MeetingShowSelected","Component","constructor","props","dualShareHandler","mediaStream","setState","localStream","errorHandler","error","console","log","message","shareScreenChange","e","isChecked","target","checked","state","dualStream","navigator","mediaDevices","getDisplayMedia","displayMediaOptions","getUserMedia","camMediaOptions","shareScreen","trackArr","getTracks","i","length","removeTrack","addTrack","onSocketConnect","socket","emit","userName","loggedInUserFullName","userId","loggedInUser","onUpdateUserList","userIds","newUserIds","forEach","id","includes","push","nameMap","userNameMap","organiserId","callMadeByNonOrganiser","callUser","peerConnections","RTCPeerConnection","iceServers","isRemotePlaying","callAttempts","offer","createOffer","setLocalDescription","RTCSessionDescription","JSON","stringify","to","from","onCallRcvd","callRcvd","setRemoteDescription","answer","createAnswer","onAnswerRcvd","answerRcvd","onAckCalleeRcvd","then","onRemoveUser","filter","val","attr","handleIceCandidate","icons","remoteStreams","params","match","meetingId","video","cursor","audio","echoCancellation","noiseSuppression","componentDidMount","catch","render","map"],"mappings":"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","sourcesContent":["import React from 'react';\nimport {  Redirect } from 'react-router-dom';\nimport socketIOClient from \"socket.io-client\";\nimport data from \"./data\";\nimport '../css/Chat.css';\nimport VideoExt from './chat/VideoExt';\nimport SocketX from './chat/SocketX';\nimport PeerConnectionExt from './chat/PeerConnectionExt';\n\nconst ICE_SERVERS=[\n  {\n    urls: 'turn:numb.viagenie.ca',\n    credential: 'muazkh',\n    username: 'webrtc@live.com'\n  },\n  {\n      url: 'turn:192.158.29.39:3478?transport=tcp',\n      credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',\n      username: '28224511:1379330808'\n  },\n  {\n      url: 'turn:turn.anyfirewall.com:443?transport=tcp',\n      credential: 'webrtc',\n      username: 'webrtc'\n  },\n  {\n      url: 'turn:13.250.13.83:3478?transport=tcp',\n      credential: 'YzYNCouZM1mhqhmseWk6',\n      username: 'YzYNCouZM1mhqhmseWk6'\n  },\n  { urls: 'stun:stun.l.google.com:19302' },\n  /*{ urls: 'stun:stun1.l.google.com:19302' },\n  { urls: 'stun:stun2.l.google.com:19302' },\n  { urls: 'stun:stun3.l.google.com:19302' },\n  { urls: 'stun:stun4.l.google.com:19302' },*/\n  { urls: 'stun:stun.ekiga.net'}\n];\n\nclass MeetingShowSelected extends React.Component{\n  constructor(props){\n    super(props);\n    this.state={\n      icons: data.icons,\n      userIds:[],\n      userNameMap:{},\n      message: 'Select a user on the left menu to start sharing.',\n      callMadeByNonOrganiser: false,\n      callRcvd: false,\n      answerRcvd: false,\n      localStream: null,\n      remoteStreams: null,\n      shareScreen: false\n    }\n    const {params}= this.props.match;\n\n    this.meetingId=params.id;\n    this.organiserId=params.organiserId;\n    this.peerConnections={};\n    this.callAttempts={};\n    this.isRemotePlaying={};\n\n    //this.socket = socketIOClient(ENDPOINT);\n    this.socket = socketIOClient(\"/\"+this.meetingId);\n\n    this.displayMediaOptions = {\n      video: {\n        cursor: \"always\"\n      },\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n    this.camMediaOptions={\n      video: true,\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n  }\n\n  dualShareHandler=(mediaStream)=>{\n    this.setState({localStream: mediaStream});\n  };\n\n  errorHandler=error => {\n    console.log(error.message);\n  };\n\n  shareScreenChange=async (e)=>{\n    let isChecked=e.target.checked;\n    let {localStream}=this.state;\n    let dualStream;\n    if(isChecked){\n        dualStream=await navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions);\n    }\n    else{\n      dualStream=await navigator.mediaDevices.getUserMedia(this.camMediaOptions);\n    }\n    if(localStream===null){\n      //dualStream.getTracks().forEach(track => this.peerConnection.addTrack(track));\n      this.setState({localStream: dualStream, shareScreen: isChecked})\n    }\n    else{\n      let trackArr=[...localStream.getTracks()];\n      for(let i=0;i<trackArr.length;i++)\n          await localStream.removeTrack(trackArr[i]);\n\n      //const senders = this.peerConnection.getSenders();\n      for(let i=0;i<dualStream.getTracks().length;i++){\n          await localStream.addTrack(dualStream.getTracks()[i]);\n          /*senders.forEach((sender) => {\n                              if(dualStream.getTracks()[i].kind===sender.track.kind)\n                                  sender.replaceTrack(dualStream.getTracks()[i]);\n                            });*/\n      }\n      this.setState({shareScreen: isChecked});\n    }\n  }\n\n  componentDidMount(){\n    if(this.props.loggedInUserFullName!==''){\n        if(this.state.shareScreen){\n            navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);\n        }\n        else{\n          navigator.mediaDevices.getUserMedia(this.camMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);;\n        }\n   }\n\n  }\n\n  onSocketConnect=()=>{\n    if(this.socket){\n      this.socket.emit(\"map\", {\n        userName: this.props.loggedInUserFullName,\n        userId: this.props.loggedInUser\n      });\n      console.log(this.socket);\n      console.log(' mapped to '+this.props.loggedInUser);\n    }\n  }\n\n  onUpdateUserList=(data) => {\n    let userIds=[...this.state.userIds];\n    let newUserIds=data.userIds;\n    newUserIds.forEach(id=>{\n      if(!userIds.includes(id))\n        userIds.push(id);\n    });\n\n    console.log('In update user list');\n    console.log(userIds);\n    console.log(data.nameMap);\n    this.setState({userIds, userNameMap: data.nameMap}, ()=>{\n      if(userIds.includes(this.organiserId) && !this.state.callMadeByNonOrganiser)\n        this.callUser(this.organiserId);\n    });\n  };\n\n  callUser=async (userId)=>{\n    console.log('Call User '+userId+' '+this.state.userNameMap[userId]);\n    this.peerConnections[userId] = new RTCPeerConnection({ iceServers: ICE_SERVERS });\n\n    if(!this.isRemotePlaying[userId])\n      this.isRemotePlaying[userId]=false;\n\n    if(!this.callAttempts[userId])\n      this.callAttempts[userId]=0;\n    else\n      this.callAttempts[userId]++;\n\n    const offer = await this.peerConnections[userId].createOffer();\n    await this.peerConnections[userId].setLocalDescription(new RTCSessionDescription(offer));\n    console.log(JSON.stringify(offer));\n    //console.log(this.peerConnection);\n    if(!this.isRemotePlaying[userId] && this.callAttempts[userId]<3){\n        this.socket.emit(\"call-user\", {\n          offer,\n          to: userId,\n          from: this.props.loggedInUser\n        });\n        if(this.organiserId!==this.state.loggedInUser)\n          this.setState({callMadeByNonOrganiser: true, message: `Talking with: user: ${this.state.userNameMap[userId]} (${userId})`});\n        else\n          this.setState({message: `Talking with: user: ${this.state.userNameMap[userId]} (${userId})`});\n    }\n\n  }\n\n  onCallRcvd=async (data) => {\n    console.log('callRcvd '+this.state.callRcvd);\n    this.peerConnections[data.from] = new RTCPeerConnection({ iceServers: ICE_SERVERS });\n    await this.peerConnections[data.from].setRemoteDescription(\n      new RTCSessionDescription(data.offer)\n    );\n    const answer = await this.peerConnections[data.from].createAnswer();\n    console.log('call received');\n    console.log('answer \\n'+JSON.stringify(answer));\n    await this.peerConnections[data.from].setLocalDescription(new RTCSessionDescription(answer));\n    //console.log(this.peerConnections[data.from]);\n    this.socket.emit(\"make-answer\", {\n      answer,\n      to: data.from,\n      from: this.props.loggedInUser\n    });\n    this.setState({callRcvd: true});\n  }\n\n  onAnswerRcvd=async (data) => {\n     console.log('on Answer Rcvd'+JSON.stringify(data.answer));\n\n      await this.peerConnections[data.from].setRemoteDescription(\n        new RTCSessionDescription(data.answer)\n      );\n      if (!this.state.answerRcvd && !this.state.callRcvd)\n      {\n        this.setState({answerRcvd: true});\n      }\n      this.socket.emit(\"ack-callee\", {\n        to: data.from,\n        from: this.props.loggedInUser\n      });\n  }\n\n  onAckCalleeRcvd=(data)=>{\n      console.log('on ack callee received, callAttempts '+this.callAttempts[data.from]+' remotePlaying'+this.isRemotePlaying[data.from]);\n     //if(this.state.remoteStream.getTracks().length<=0 && this.callAttempts<3){\n      this.callUser(data.from, null).then();\n  }\n\n\n  onRemoveUser=({ userId }) => {\n    console.log('removing user '+userId);\n    let userIds=this.state.userIds.filter((val)=>val!==userId);\n    let userNameMap={};\n    for(let attr in this.state.userNameMap){\n      if(userIds.includes(attr))\n        userNameMap[attr]=this.state.userNameMap[attr];\n    }\n    if(this.props.loggedInUser===this.organiserId){\n      delete this.peerConnections[userId];\n    }\n    if(userId===this.organiserId)\n      this.setState({userNameMap, userIds, callMadeByNonOrganiser: false});\n    else\n     this.setState({userNameMap, userIds});\n  }\n\n  handleIceCandidate = async (data) => {\n  }\n\n\n\n  render(){\n      if(this.props.loggedInUserFullName===''){\n        return <Redirect to=\"/errorLogin\"/>\n      }\n      else\n      {\n          return (\n            <div>\n            Meeting Show Selected\n             <SocketX\n              socket={this.socket}\n              onSocketConnect={this.onSocketConnect}\n              onUpdateUserList={this.onUpdateUserList}\n              onRemoveUser={this.onRemoveUser}\n              onCallRcvd={this.onCallRcvd}\n              onAnswerRcvd={this.onAnswerRcvd}\n              onAckCalleeRcvd={this.onAckCalleeRcvd}\n              handleIceCandidate={this.handleIceCandidate}\n              />\n              <div className=\"content-container\">\n                    <div className=\"active-users-panel\"  id=\"active-user-container\">\n                      <h3 className=\"panel-title\">Callable Users:</h3>\n                      {this.state.userIds.map(val=>(<div id={val} key={val}    className=\"active-user\">\n                                                        <p className=\"username\">\n                                                          {this.state.userNameMap[val]}({val})\n                                                        </p>\n                                                       </div>\n                                                       )\n                                            )}\n                    </div>\n                    <div className=\"video-chat-container\">\n                          {/*<h2>Logged In User: {this.props.loggedInUserFullName}</h2>*/}\n                          <h2 className=\"talk-info\" id=\"talking-with-info\">\n                            {this.state.message}\n                          </h2>\n                          <div className=\"video-container\">\n                            Share Screen: <input type=\"checkbox\" id=\"shareScreen\" checked={this.state.shareScreen}\n                                            onChange={this.shareScreenChange}/>\n                            <br/>\n                            <VideoExt\n                             controls={true}\n                             muted=\"muted\"\n                             mediaStream={this.state.localStream} />\n                          </div>\n                    </div>\n              </div>\n            </div>\n          )\n      }\n  }\n}\n\nexport default MeetingShowSelected;\n"]},"metadata":{},"sourceType":"module"}