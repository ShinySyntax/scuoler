{"ast":null,"code":"var _jsxFileName = \"/home/mathew/javascript/ischools-react/client/src/components/MeetingShowSelected.js\";\nimport React from 'react';\nimport { Redirect } from 'react-router-dom';\nimport socketIOClient from \"socket.io-client\";\nimport data from \"./data\";\nimport '../css/Chat.css';\nimport VideoExt from './chat/VideoExt';\nimport SocketX from './chat/SocketX';\nimport PeerConnectionExt from './chat/PeerConnectionExt';\nconst ICE_SERVERS = [{\n  urls: 'turn:numb.viagenie.ca',\n  credential: 'muazkh',\n  username: 'webrtc@live.com'\n}, {\n  url: 'turn:192.158.29.39:3478?transport=tcp',\n  credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',\n  username: '28224511:1379330808'\n}, {\n  url: 'turn:turn.anyfirewall.com:443?transport=tcp',\n  credential: 'webrtc',\n  username: 'webrtc'\n}, {\n  url: 'turn:13.250.13.83:3478?transport=tcp',\n  credential: 'YzYNCouZM1mhqhmseWk6',\n  username: 'YzYNCouZM1mhqhmseWk6'\n}, {\n  urls: 'stun:stun.l.google.com:19302'\n},\n/*{ urls: 'stun:stun1.l.google.com:19302' },\n{ urls: 'stun:stun2.l.google.com:19302' },\n{ urls: 'stun:stun3.l.google.com:19302' },\n{ urls: 'stun:stun4.l.google.com:19302' },*/\n{\n  urls: 'stun:stun.ekiga.net'\n}];\n\nclass MeetingShowSelected extends React.Component {\n  constructor(props) {\n    super(props);\n\n    this.dualShareHandler = mediaStream => {\n      console.log('in dual share handler');\n      this.setState({\n        localStream: mediaStream\n      }, () => {\n        for (let key in this.peerConnections) this.addLocalStreamToPeerCon(key);\n      });\n\n      if (this.props.loggedInUser === this.organiserId) {\n        this.socket.emit(\"call-organiser\", {});\n      } else if (this.props.loggedInUser !== this.organiserId && this.state.userIds.includes(this.organiserId)) {\n        this.callUser(this.organiserId).then(); //this.setState({callMadeByNonOrganiser: true});\n      }\n    };\n\n    this.errorHandler = error => {\n      console.log(error.message);\n    };\n\n    this.shareScreenChange = async e => {\n      let isChecked = e.target.checked;\n      let {\n        localStream\n      } = this.state;\n      let dualStream;\n\n      if (isChecked) {\n        dualStream = await navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions);\n      } else {\n        dualStream = await navigator.mediaDevices.getUserMedia(this.camMediaOptions);\n      }\n\n      if (localStream === null) {\n        for (let key in this.peerConnections) dualStream.getTracks().forEach(track => this.peerConnections[key].addTrack(track));\n\n        this.setState({\n          localStream: dualStream,\n          shareScreen: isChecked\n        });\n      } else {\n        let trackArr = [...localStream.getTracks()];\n\n        for (let i = 0; i < trackArr.length; i++) await localStream.removeTrack(trackArr[i]);\n\n        for (let i = 0; i < dualStream.getTracks().length; i++) {\n          await localStream.addTrack(dualStream.getTracks()[i]);\n\n          for (let key in this.peerConnections) {\n            const senders = this.peerConnections[key].getSenders();\n            senders.forEach(sender => {\n              if (dualStream.getTracks()[i].kind === sender.track.kind) sender.replaceTrack(dualStream.getTracks()[i]);\n            });\n          }\n        }\n\n        this.setState({\n          localStream,\n          shareScreen: isChecked\n        });\n      }\n    };\n\n    this.onSocketConnect = () => {\n      if (this.socket) {\n        this.socket.emit(\"map\", {\n          userName: this.props.loggedInUserFullName,\n          userId: this.props.loggedInUser\n        });\n        console.log(this.socket.id + ' mapped to ' + this.props.loggedInUser);\n      }\n    };\n\n    this.addLocalStreamToPeerCon = sourceId => {\n      if (this.state.localStream && this.isLocalStreamAdded[sourceId] !== true) {\n        console.log('local stream tracks length ' + this.state.localStream.getTracks().length);\n        this.state.localStream.getTracks().forEach(track => this.peerConnections[sourceId].addTrack(track));\n        this.isLocalStreamAdded[sourceId] = true;\n      }\n    };\n\n    this.onUpdateUserList = data => {\n      console.log('In update user list');\n      let userIds = [...this.state.userIds];\n      let newUserIds = data.userIds;\n      let remoteStreams = Object.assign({}, this.state.remoteStreams);\n      newUserIds.forEach(id => {\n        if (!userIds.includes(id)) {\n          userIds.push(id);\n          this.peerConnections[id] = new RTCPeerConnection({\n            iceServers: ICE_SERVERS\n          });\n          this.isLocalStreamAdded[id] = false;\n          this.callAttempts[id] = 0;\n          this.isRemotePlaying[id] = false;\n          this.addLocalStreamToPeerCon(id);\n          remoteStreams[id] = new MediaStream();\n\n          if (this.props.loggedInUser !== this.organiserId && this.organiserId === id) {\n            this.peerConnections[this.organiserId] = new RTCPeerConnection({\n              iceServers: ICE_SERVERS\n            });\n            this.isLocalStreamAdded[this.organiserId] = false;\n            this.callAttempts[this.organiserId] = 0;\n            this.isRemotePlaying[this.organiserId] = false;\n            this.addLocalStreamToPeerCon(this.organiserId);\n            remoteStreams[this.organiserId] = new MediaStream();\n            this.setState({\n              remoteStreams,\n              userIds,\n              userNameMap: data.nameMap\n            });\n\n            if (this.isLocalStreamAdded[this.organiserId] === true) {\n              this.callUser(this.organiserId).then(); //this.setState({callMadeByNonOrganiser: true});\n            }\n          }\n        }\n      });\n      console.log(userIds);\n      console.log(data.nameMap);\n      this.setState({\n        remoteStreams,\n        userIds,\n        userNameMap: data.nameMap\n      }, () => {\n        if (this.props.loggedInUser === this.organiserId) {\n          this.socket.emit(\"call-organiser\", {});\n        }\n      });\n    };\n\n    this.handleCallOrganiser = () => {\n      console.log('handle call organiser');\n\n      if (this.state.userIds.includes(this.organiserId)) {\n        this.callAttempts[this.organiserId] = 0;\n        this.isRemotePlaying[this.organiserId] = false;\n        this.callUser(this.organiserId).then(); //this.setState({callMadeByNonOrganiser: true});\n      }\n    };\n\n    this.callUser = async userId => {\n      console.log('Call User ' + userId + ' ' + this.state.userNameMap[userId]); //if(this.isRemotePlaying[userId]===undefined)\n      //  this.isRemotePlaying[userId]=false;\n\n      if (this.callAttempts[userId] === undefined) this.callAttempts[userId] = 1;else this.callAttempts[userId]++;\n      console.log('remoteStreams');\n      console.log(this.state.remoteStreams[userId]);\n      console.log(this.peerConnections[userId]);\n\n      if (this.peerConnections[userId] === undefined) {\n        this.peerConnections[userId] = new RTCPeerConnection({\n          iceServers: ICE_SERVERS\n        });\n        this.isLocalStreamAdded[userId] = false;\n      }\n\n      this.addLocalStreamToPeerCon(userId);\n\n      if (this.state.remoteStreams[userId] === undefined) {\n        let remoteStreams = Object.assign({}, this.state.remoteStreams);\n        remoteStreams[userId] = new MediaStream();\n        this.setState({\n          remoteStreams\n        });\n      } //console.log(this.peerConnection);\n\n\n      console.log('Call Attempts ' + this.callAttempts[userId]);\n      const offer = await this.peerConnections[userId].createOffer();\n      await this.peerConnections[userId].setLocalDescription(new RTCSessionDescription(offer));\n      this.socket.emit(\"call-user\", {\n        offer,\n        to: userId,\n        from: this.props.loggedInUser\n      });\n      this.setState({\n        message: `Talking with: user: ${this.state.userNameMap[userId]} (${userId})`\n      });\n    };\n\n    this.onCallRcvd = async data => {\n      console.log('callRcvd ');\n      console.log('remoteStreams');\n      console.log(this.state.remoteStreams[data.from]);\n      console.log(this.peerConnections[data.from]);\n\n      if (this.peerConnections[data.from] === undefined) {\n        this.peerConnections[data.from] = new RTCPeerConnection({\n          iceServers: ICE_SERVERS\n        });\n        this.isLocalStreamAdded[data.from] = false;\n      }\n\n      this.addLocalStreamToPeerCon(data.from);\n\n      if (this.state.remoteStreams[data.from] === undefined) {\n        let remoteStreams = Object.assign({}, this.state.remoteStreams);\n        remoteStreams[data.from] = new MediaStream();\n        this.setState({\n          remoteStreams\n        });\n      }\n\n      await this.peerConnections[data.from].setRemoteDescription(new RTCSessionDescription(data.offer));\n      const answer = await this.peerConnections[data.from].createAnswer();\n      console.log('answer \\n' + JSON.stringify(answer));\n      await this.peerConnections[data.from].setLocalDescription(new RTCSessionDescription(answer)); //console.log(this.peerConnections[data.from]);\n\n      this.socket.emit(\"make-answer\", {\n        answer,\n        to: data.from,\n        from: this.props.loggedInUser\n      });\n    };\n\n    this.onAnswerRcvd = async data => {\n      console.log('on Answer Rcvd' + JSON.stringify(data.answer));\n      console.log(this.state.remoteStreams[data.from]);\n      console.log(this.peerConnections[data.from]);\n      this.addLocalStreamToPeerCon(data.from);\n\n      if (this.peerConnections[data.from].signalingState !== \"stable\") {\n        await this.peerConnections[data.from].setRemoteDescription(new RTCSessionDescription(data.answer));\n      }\n\n      this.socket.emit(\"ack-callee\", {\n        to: data.from,\n        from: this.props.loggedInUser\n      });\n    };\n\n    this.onAckCalleeRcvd = data => {\n      console.log('remoteStreams');\n      console.log(this.state.remoteStreams[data.from]);\n      console.log(this.peerConnections[data.from]);\n      console.log('on ack callee received, callAttempts ' + this.callAttempts[data.from] + ' remotePlaying' + this.isRemotePlaying[data.from]); //if(this.state.remoteStreams[data.from].getVideoTracks().length<=0 && this.state.remoteStreams[data.from].getAudioTracks().length<=0 && this.callAttempts[data.from]<3)\n\n      if (!this.isRemotePlaying[data.from] && this.callAttempts[data.from] < 4) this.callUser(data.from).then();\n    };\n\n    this.onRemoveUser = ({\n      userId\n    }) => {\n      console.log('removing user ' + userId);\n      let userIds = this.state.userIds.filter(val => val !== userId);\n      let userNameMap = {};\n\n      for (let attr in this.state.userNameMap) {\n        if (userIds.includes(attr)) userNameMap[attr] = this.state.userNameMap[attr];\n      }\n\n      delete this.peerConnections[userId];\n      let remoteStreams = Object.assign({}, this.state.remoteStreams);\n      delete remoteStreams[userId];\n      this.isLocalStreamAdded[userId] = false;\n      this.callAttempts[userId] = 0;\n      this.isRemotePlaying[userId] = false;\n      if (userId === this.organiserId) this.setState({\n        userNameMap,\n        remoteStreams,\n        userIds\n      }); //, callMadeByNonOrganiser: false\n      else this.setState({\n          userNameMap,\n          remoteStreams,\n          userIds\n        });\n    };\n\n    this.handleIceCandidate = async data => {\n      const candidate = JSON.parse(data);\n      const revCandidate = new RTCIceCandidate({\n        sdpMLineIndex: candidate.sdpMLineIndex,\n        candidate: candidate.candidate\n      });\n\n      for (let key in this.peerConnections) await this.peerConnections[key].addIceCandidate(revCandidate);\n    };\n\n    this.handleOnIceEvent = rtcPeerConnectionIceEvent => {\n      console.log('ICE event handle');\n\n      if (rtcPeerConnectionIceEvent.candidate && this.peerConnections) {\n        const {\n          candidate\n        } = rtcPeerConnectionIceEvent;\n        this.socket.emit(\"ice-candidate\", JSON.stringify(candidate));\n      }\n    };\n\n    this.onRemoteVideoPlaying = (e, key) => {\n      this.isRemotePlaying[key] = true;\n      console.log('remote video playing event for remote user ' + key);\n      console.log(e);\n    };\n\n    this.state = {\n      localStream: null,\n      remoteStreams: {},\n      shareScreen: false,\n      //peerConnections: {},\n      icons: data.icons,\n      userIds: [],\n      userNameMap: {},\n      message: 'Select a user on the left menu to start sharing.' //callMadeByNonOrganiser: false\n\n    };\n    const {\n      params\n    } = this.props.match;\n    this.meetingId = params.id;\n    this.organiserId = params.organiserId;\n    this.peerConnections = {};\n    this.callAttempts = {};\n    this.isRemotePlaying = {};\n    this.isLocalStreamAdded = {}; //this.socket = socketIOClient(ENDPOINT);\n\n    this.socket = socketIOClient(\"/\" + this.meetingId);\n    this.displayMediaOptions = {\n      video: {\n        cursor: \"always\"\n      },\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n    this.camMediaOptions = {\n      video: true,\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n  }\n\n  componentDidMount() {\n    if (this.props.loggedInUserFullName !== '') {\n      if (this.state.shareScreen) {\n        navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);\n      } else {\n        navigator.mediaDevices.getUserMedia(this.camMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);\n      }\n    }\n  }\n\n  render() {\n    if (this.props.loggedInUserFullName === '') {\n      return /*#__PURE__*/React.createElement(Redirect, {\n        to: \"/errorLogin\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 366,\n          columnNumber: 16\n        }\n      });\n    } else {\n      return /*#__PURE__*/React.createElement(\"div\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 371,\n          columnNumber: 13\n        }\n      }, \"Meeting Show Selected\", /*#__PURE__*/React.createElement(SocketX, {\n        socket: this.socket,\n        onSocketConnect: this.onSocketConnect,\n        onUpdateUserList: this.onUpdateUserList,\n        onRemoveUser: this.onRemoveUser,\n        onCallRcvd: this.onCallRcvd,\n        onAnswerRcvd: this.onAnswerRcvd,\n        onAckCalleeRcvd: this.onAckCalleeRcvd,\n        handleIceCandidate: this.handleIceCandidate,\n        handleCallOrganiser: this.handleCallOrganiser,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 373,\n          columnNumber: 14\n        }\n      }), Object.keys(this.state.remoteStreams).map(key => /*#__PURE__*/React.createElement(PeerConnectionExt, {\n        peerConnection: this.peerConnections[key],\n        localStream: this.state.localStream,\n        remoteStream: this.state.remoteStreams[key],\n        handleOnIceEvent: this.handleOnIceEvent,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 385,\n          columnNumber: 17\n        }\n      })), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"content-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 393,\n          columnNumber: 15\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"active-users-panel\",\n        id: \"active-user-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 394,\n          columnNumber: 21\n        }\n      }, /*#__PURE__*/React.createElement(\"h3\", {\n        className: \"panel-title\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 395,\n          columnNumber: 23\n        }\n      }, \"Callable Users:\"), this.state.userIds.map(val => /*#__PURE__*/React.createElement(\"div\", {\n        id: val,\n        key: val,\n        className: \"active-user\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 396,\n          columnNumber: 53\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        className: \"username\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 397,\n          columnNumber: 57\n        }\n      }, this.state.userNameMap[val], \"(\", val, \")\")))), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"video-chat-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 404,\n          columnNumber: 21\n        }\n      }, /*#__PURE__*/React.createElement(\"h2\", {\n        className: \"talk-info\",\n        id: \"talking-with-info\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 406,\n          columnNumber: 27\n        }\n      }, this.state.message), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"video-container\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 409,\n          columnNumber: 27\n        }\n      }, \"Share Screen: \", /*#__PURE__*/React.createElement(\"input\", {\n        type: \"checkbox\",\n        id: \"shareScreen\",\n        checked: this.state.shareScreen,\n        onChange: this.shareScreenChange,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 410,\n          columnNumber: 43\n        }\n      }), /*#__PURE__*/React.createElement(\"br\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 412,\n          columnNumber: 29\n        }\n      }), /*#__PURE__*/React.createElement(VideoExt, {\n        controls: true,\n        muted: \"muted\",\n        mediaStream: this.state.localStream,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 413,\n          columnNumber: 29\n        }\n      }), Object.keys(this.state.remoteStreams).map(key => /*#__PURE__*/React.createElement(VideoExt, {\n        controls: true,\n        mediaStream: this.state.remoteStreams[key],\n        onPlaying: e => this.onRemoteVideoPlaying(e, key),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 418,\n          columnNumber: 32\n        }\n      }))))));\n    }\n  }\n\n}\n\nexport default MeetingShowSelected;","map":{"version":3,"sources":["/home/mathew/javascript/ischools-react/client/src/components/MeetingShowSelected.js"],"names":["React","Redirect","socketIOClient","data","VideoExt","SocketX","PeerConnectionExt","ICE_SERVERS","urls","credential","username","url","MeetingShowSelected","Component","constructor","props","dualShareHandler","mediaStream","console","log","setState","localStream","key","peerConnections","addLocalStreamToPeerCon","loggedInUser","organiserId","socket","emit","state","userIds","includes","callUser","then","errorHandler","error","message","shareScreenChange","e","isChecked","target","checked","dualStream","navigator","mediaDevices","getDisplayMedia","displayMediaOptions","getUserMedia","camMediaOptions","getTracks","forEach","track","addTrack","shareScreen","trackArr","i","length","removeTrack","senders","getSenders","sender","kind","replaceTrack","onSocketConnect","userName","loggedInUserFullName","userId","id","sourceId","isLocalStreamAdded","onUpdateUserList","newUserIds","remoteStreams","Object","assign","push","RTCPeerConnection","iceServers","callAttempts","isRemotePlaying","MediaStream","userNameMap","nameMap","handleCallOrganiser","undefined","offer","createOffer","setLocalDescription","RTCSessionDescription","to","from","onCallRcvd","setRemoteDescription","answer","createAnswer","JSON","stringify","onAnswerRcvd","signalingState","onAckCalleeRcvd","onRemoveUser","filter","val","attr","handleIceCandidate","candidate","parse","revCandidate","RTCIceCandidate","sdpMLineIndex","addIceCandidate","handleOnIceEvent","rtcPeerConnectionIceEvent","onRemoteVideoPlaying","icons","params","match","meetingId","video","cursor","audio","echoCancellation","noiseSuppression","componentDidMount","catch","render","keys","map"],"mappings":"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","sourcesContent":["import React from 'react';\nimport {  Redirect } from 'react-router-dom';\nimport socketIOClient from \"socket.io-client\";\nimport data from \"./data\";\nimport '../css/Chat.css';\nimport VideoExt from './chat/VideoExt';\nimport SocketX from './chat/SocketX';\nimport PeerConnectionExt from './chat/PeerConnectionExt';\n\nconst ICE_SERVERS=[\n  {\n    urls: 'turn:numb.viagenie.ca',\n    credential: 'muazkh',\n    username: 'webrtc@live.com'\n  },\n  {\n      url: 'turn:192.158.29.39:3478?transport=tcp',\n      credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',\n      username: '28224511:1379330808'\n  },\n  {\n      url: 'turn:turn.anyfirewall.com:443?transport=tcp',\n      credential: 'webrtc',\n      username: 'webrtc'\n  },\n  {\n      url: 'turn:13.250.13.83:3478?transport=tcp',\n      credential: 'YzYNCouZM1mhqhmseWk6',\n      username: 'YzYNCouZM1mhqhmseWk6'\n  },\n  { urls: 'stun:stun.l.google.com:19302' },\n  /*{ urls: 'stun:stun1.l.google.com:19302' },\n  { urls: 'stun:stun2.l.google.com:19302' },\n  { urls: 'stun:stun3.l.google.com:19302' },\n  { urls: 'stun:stun4.l.google.com:19302' },*/\n  { urls: 'stun:stun.ekiga.net'}\n];\n\nclass MeetingShowSelected extends React.Component{\n  constructor(props){\n    super(props);\n    this.state={\n      localStream: null,\n      remoteStreams: {},\n      shareScreen: false,\n      //peerConnections: {},\n      icons: data.icons,\n      userIds:[],\n      userNameMap:{},\n      message: 'Select a user on the left menu to start sharing.',\n      //callMadeByNonOrganiser: false\n    }\n    const {params}= this.props.match;\n\n    this.meetingId=params.id;\n    this.organiserId=params.organiserId;\n\n    this.peerConnections={};\n    this.callAttempts={};\n    this.isRemotePlaying={};\n    this.isLocalStreamAdded={};\n\n    //this.socket = socketIOClient(ENDPOINT);\n    this.socket = socketIOClient(\"/\"+this.meetingId);\n\n    this.displayMediaOptions = {\n      video: {\n        cursor: \"always\"\n      },\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n    this.camMediaOptions={\n      video: true,\n      audio: {\n        echoCancellation: true,\n        noiseSuppression: true\n      }\n    };\n  }\n\n  dualShareHandler=(mediaStream)=>{\n    console.log('in dual share handler');\n    this.setState({localStream: mediaStream}, ()=>{\n       for(let key in this.peerConnections)\n          this.addLocalStreamToPeerCon(key);\n    });\n\n    if(this.props.loggedInUser===this.organiserId){\n      this.socket.emit(\"call-organiser\", {});\n    }\n    else if(this.props.loggedInUser!==this.organiserId && this.state.userIds.includes(this.organiserId)){\n      this.callUser(this.organiserId).then();\n      //this.setState({callMadeByNonOrganiser: true});\n    }\n  }\n\n\n  errorHandler=error => {\n    console.log(error.message);\n  }\n\n  shareScreenChange=async (e)=>{\n    let isChecked=e.target.checked;\n    let {localStream}=this.state;\n    let dualStream;\n    if(isChecked){\n        dualStream=await navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions);\n    }\n    else{\n      dualStream=await navigator.mediaDevices.getUserMedia(this.camMediaOptions);\n    }\n    if(localStream===null){\n      for(let key in this.peerConnections)\n          dualStream.getTracks().forEach(track => this.peerConnections[key].addTrack(track));\n\n      this.setState({localStream: dualStream, shareScreen: isChecked})\n    }\n    else{\n      let trackArr=[...localStream.getTracks()];\n      for(let i=0;i<trackArr.length;i++)\n          await localStream.removeTrack(trackArr[i]);\n\n      for(let i=0;i<dualStream.getTracks().length;i++){\n          await localStream.addTrack(dualStream.getTracks()[i]);\n          for(let key in this.peerConnections){\n              const senders = this.peerConnections[key].getSenders();\n              senders.forEach((sender) => {\n                                  if(dualStream.getTracks()[i].kind===sender.track.kind)\n                                      sender.replaceTrack(dualStream.getTracks()[i]);\n                                });\n          }\n\n      }\n      this.setState({localStream, shareScreen: isChecked});\n    }\n  }\n\n  componentDidMount(){\n    if(this.props.loggedInUserFullName!==''){\n        if(this.state.shareScreen){\n            navigator.mediaDevices.getDisplayMedia(this.displayMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);\n        }\n        else{\n          navigator.mediaDevices.getUserMedia(this.camMediaOptions).then(this.dualShareHandler).catch(this.errorHandler);\n        }\n   }\n  }\n\n  onSocketConnect=()=>{\n    if(this.socket){\n      this.socket.emit(\"map\", {\n        userName: this.props.loggedInUserFullName,\n        userId: this.props.loggedInUser\n      });\n      console.log(this.socket.id+' mapped to '+this.props.loggedInUser);\n    }\n  }\n\n  addLocalStreamToPeerCon=(sourceId)=>{\n    if(this.state.localStream && this.isLocalStreamAdded[sourceId]!==true){\n      console.log('local stream tracks length '+this.state.localStream.getTracks().length);\n      this.state.localStream.getTracks().forEach(track => this.peerConnections[sourceId].addTrack(track));\n      this.isLocalStreamAdded[sourceId]=true;\n    }\n  }\n\n  onUpdateUserList=(data) => {\n    console.log('In update user list');\n    let userIds=[...this.state.userIds];\n    let newUserIds=data.userIds;\n    let remoteStreams=Object.assign({}, this.state.remoteStreams);\n    newUserIds.forEach(id=>{\n      if(!userIds.includes(id)){\n        userIds.push(id);\n        this.peerConnections[id] = new RTCPeerConnection({ iceServers: ICE_SERVERS });\n        this.isLocalStreamAdded[id] = false;\n        this.callAttempts[id]=0;\n        this.isRemotePlaying[id]=false;\n        this.addLocalStreamToPeerCon(id);\n        remoteStreams[id] = new MediaStream();\n        if(this.props.loggedInUser!==this.organiserId && this.organiserId===id){\n           this.peerConnections[this.organiserId] = new RTCPeerConnection({ iceServers: ICE_SERVERS });\n           this.isLocalStreamAdded[this.organiserId] = false;\n           this.callAttempts[this.organiserId]=0;\n           this.isRemotePlaying[this.organiserId]=false;\n           this.addLocalStreamToPeerCon(this.organiserId);\n           remoteStreams[this.organiserId] = new MediaStream();\n           this.setState({remoteStreams, userIds, userNameMap: data.nameMap});\n           if(this.isLocalStreamAdded[this.organiserId]===true){\n               this.callUser(this.organiserId).then();\n               //this.setState({callMadeByNonOrganiser: true});\n           }\n       }\n      }\n    });\n    console.log(userIds);\n    console.log(data.nameMap);\n    this.setState({remoteStreams, userIds, userNameMap: data.nameMap}, ()=>{\n      if(this.props.loggedInUser===this.organiserId){\n              this.socket.emit(\"call-organiser\", {});\n      }\n    });\n  };\n\n  handleCallOrganiser=()=>{\n    console.log('handle call organiser');\n    if(this.state.userIds.includes(this.organiserId)){\n        this.callAttempts[this.organiserId]=0;\n        this.isRemotePlaying[this.organiserId]=false;\n        this.callUser(this.organiserId).then();\n        //this.setState({callMadeByNonOrganiser: true});\n    }\n  }\n\n\n  callUser=async (userId)=>{\n    console.log('Call User '+userId+' '+this.state.userNameMap[userId]);\n    //if(this.isRemotePlaying[userId]===undefined)\n    //  this.isRemotePlaying[userId]=false;\n\n    if(this.callAttempts[userId]===undefined)\n      this.callAttempts[userId]=1;\n    else\n      this.callAttempts[userId]++;\n\n    console.log('remoteStreams');\n    console.log(this.state.remoteStreams[userId]);\n    console.log(this.peerConnections[userId]);\n\n    if(this.peerConnections[userId]===undefined){\n        this.peerConnections[userId] = new RTCPeerConnection({ iceServers: ICE_SERVERS });\n        this.isLocalStreamAdded[userId]=false;\n    }\n    this.addLocalStreamToPeerCon(userId);\n\n    if(this.state.remoteStreams[userId]===undefined){\n      let remoteStreams=Object.assign({}, this.state.remoteStreams);\n      remoteStreams[userId] = new MediaStream();\n      this.setState({remoteStreams});\n    }\n\n    //console.log(this.peerConnection);\n\n    console.log('Call Attempts '+this.callAttempts[userId]);\n    const offer = await this.peerConnections[userId].createOffer();\n    await this.peerConnections[userId].setLocalDescription(new RTCSessionDescription(offer));\n    this.socket.emit(\"call-user\", {\n      offer,\n      to: userId,\n      from: this.props.loggedInUser\n    });\n    this.setState({message: `Talking with: user: ${this.state.userNameMap[userId]} (${userId})`});\n\n  }\n\n  onCallRcvd=async (data) => {\n    console.log('callRcvd ');\n    console.log('remoteStreams');\n    console.log(this.state.remoteStreams[data.from]);\n    console.log(this.peerConnections[data.from]);\n\n    if(this.peerConnections[data.from]===undefined){\n        this.peerConnections[data.from] = new RTCPeerConnection({ iceServers: ICE_SERVERS });\n        this.isLocalStreamAdded[data.from] = false;\n    }\n    this.addLocalStreamToPeerCon(data.from);\n\n    if(this.state.remoteStreams[data.from]===undefined){\n      let remoteStreams=Object.assign({}, this.state.remoteStreams);\n      remoteStreams[data.from]= new MediaStream();\n      this.setState({remoteStreams});\n    }\n\n    await this.peerConnections[data.from].setRemoteDescription(\n      new RTCSessionDescription(data.offer)\n    );\n    const answer = await this.peerConnections[data.from].createAnswer();\n    console.log('answer \\n'+JSON.stringify(answer));\n    await this.peerConnections[data.from].setLocalDescription(new RTCSessionDescription(answer));\n    //console.log(this.peerConnections[data.from]);\n    this.socket.emit(\"make-answer\", {\n      answer,\n      to: data.from,\n      from: this.props.loggedInUser\n    });\n  }\n\n  onAnswerRcvd=async (data) => {\n     console.log('on Answer Rcvd'+JSON.stringify(data.answer));\n     console.log(this.state.remoteStreams[data.from])\n     console.log(this.peerConnections[data.from])\n     this.addLocalStreamToPeerCon(data.from);\n     if(this.peerConnections[data.from].signalingState!== \"stable\"){\n       await this.peerConnections[data.from].setRemoteDescription(\n          new RTCSessionDescription(data.answer)\n       );\n     }\n     this.socket.emit(\"ack-callee\", {\n        to: data.from,\n        from: this.props.loggedInUser\n     });\n  }\n\n  onAckCalleeRcvd=(data)=>{\n    console.log('remoteStreams');\n    console.log(this.state.remoteStreams[data.from]);\n    console.log(this.peerConnections[data.from]);\n    console.log('on ack callee received, callAttempts '+this.callAttempts[data.from]+' remotePlaying'+this.isRemotePlaying[data.from]);\n    //if(this.state.remoteStreams[data.from].getVideoTracks().length<=0 && this.state.remoteStreams[data.from].getAudioTracks().length<=0 && this.callAttempts[data.from]<3)\n    if(!this.isRemotePlaying[data.from] && this.callAttempts[data.from]<4)\n      this.callUser(data.from).then();\n  }\n\n\n  onRemoveUser=({ userId }) => {\n    console.log('removing user '+userId);\n    let userIds=this.state.userIds.filter((val)=>val!==userId);\n    let userNameMap={};\n    for(let attr in this.state.userNameMap){\n      if(userIds.includes(attr))\n        userNameMap[attr]=this.state.userNameMap[attr];\n    }\n    delete this.peerConnections[userId];\n    let remoteStreams=Object.assign({}, this.state.remoteStreams);\n    delete remoteStreams[userId];\n    this.isLocalStreamAdded[userId] = false;\n    this.callAttempts[userId]=0;\n    this.isRemotePlaying[userId]=false;\n\n    if(userId===this.organiserId)\n      this.setState({userNameMap, remoteStreams, userIds}); //, callMadeByNonOrganiser: false\n    else\n      this.setState({userNameMap, remoteStreams, userIds});\n  }\n\n  handleIceCandidate = async (data) => {\n    const candidate = JSON.parse(data);\n    const revCandidate=new RTCIceCandidate({\n      sdpMLineIndex: candidate.sdpMLineIndex,\n      candidate: candidate.candidate\n    });\n    for(let key in this.peerConnections)\n      await this.peerConnections[key].addIceCandidate(revCandidate);\n  }\n\n  handleOnIceEvent = (rtcPeerConnectionIceEvent) => {\n    console.log('ICE event handle');\n    if (rtcPeerConnectionIceEvent.candidate && this.peerConnections) {\n        const { candidate } = rtcPeerConnectionIceEvent;\n        this.socket.emit(\"ice-candidate\",  JSON.stringify(candidate));\n    }\n  }\n\n  onRemoteVideoPlaying=(e, key)=>{\n    this.isRemotePlaying[key]=true;\n    console.log('remote video playing event for remote user '+key);\n    console.log(e);\n  }\n\n\n  render(){\n      if(this.props.loggedInUserFullName===''){\n        return <Redirect to=\"/errorLogin\"/>\n      }\n      else\n      {\n          return (\n            <div>\n            Meeting Show Selected\n             <SocketX\n              socket={this.socket}\n              onSocketConnect={this.onSocketConnect}\n              onUpdateUserList={this.onUpdateUserList}\n              onRemoveUser={this.onRemoveUser}\n              onCallRcvd={this.onCallRcvd}\n              onAnswerRcvd={this.onAnswerRcvd}\n              onAckCalleeRcvd={this.onAckCalleeRcvd}\n              handleIceCandidate={this.handleIceCandidate}\n              handleCallOrganiser={this.handleCallOrganiser}\n              />\n              {Object.keys(this.state.remoteStreams).map((key)=>(\n                <PeerConnectionExt\n                 peerConnection={this.peerConnections[key]}\n                 localStream={this.state.localStream}\n                 remoteStream={this.state.remoteStreams[key]}\n                 handleOnIceEvent={this.handleOnIceEvent}\n                />\n              ))\n              }\n              <div className=\"content-container\">\n                    <div className=\"active-users-panel\"  id=\"active-user-container\">\n                      <h3 className=\"panel-title\">Callable Users:</h3>\n                      {this.state.userIds.map(val=>(<div id={val} key={val}    className=\"active-user\">\n                                                        <p className=\"username\">\n                                                          {this.state.userNameMap[val]}({val})\n                                                        </p>\n                                                       </div>\n                                                       )\n                                            )}\n                    </div>\n                    <div className=\"video-chat-container\">\n                          {/*<h2>Logged In User: {this.props.loggedInUserFullName}</h2>*/}\n                          <h2 className=\"talk-info\" id=\"talking-with-info\">\n                            {this.state.message}\n                          </h2>\n                          <div className=\"video-container\">\n                            Share Screen: <input type=\"checkbox\" id=\"shareScreen\" checked={this.state.shareScreen}\n                                            onChange={this.shareScreenChange}/>\n                            <br/>\n                            <VideoExt\n                             controls={true}\n                             muted=\"muted\"\n                             mediaStream={this.state.localStream} />\n                             {Object.keys(this.state.remoteStreams).map(key=>(\n                               <VideoExt\n                               controls\n                               mediaStream={this.state.remoteStreams[key]}\n                               onPlaying={(e)=>this.onRemoteVideoPlaying(e, key)}\n                               />\n                             ))}\n\n                          </div>\n                    </div>\n              </div>\n            </div>\n          )\n      }\n  }\n}\n\nexport default MeetingShowSelected;\n"]},"metadata":{},"sourceType":"module"}